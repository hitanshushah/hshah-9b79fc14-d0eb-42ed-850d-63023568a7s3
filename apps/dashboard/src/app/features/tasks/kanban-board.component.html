<div class="flex flex-col">
  @if (error()) {
    <div class="mx-4 mt-4 rounded-lg border border-red-200 bg-red-50 p-3 text-red-800 dark:border-red-800 dark:bg-red-950/30 dark:text-red-200">
      {{ error() }}
    </div>
  }

  <main class="flex-1 overflow-auto py-4 px-2 lg:px-8 flex flex-col items-center">
    @if (loading()) {
      <p class="text-slate-500 dark:text-slate-400">Loading…</p>
    } @else {
      <div class="mb-3 flex w-full flex-col gap-3 self-stretch sm:flex-row sm:items-center sm:justify-between sm:gap-2">
        <div class="flex flex-wrap items-center gap-2">
          @if (isOwner()) {
            <a
              routerLink="/control-panel"
              class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600"
            >
              <span class="inline-flex shrink-0" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
              </span>
              Control Panel
            </a>
          }
          @if (canEdit()) {
            <a
              routerLink="/access-logs"
              class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600"
            >
              View Access logs
            </a>
          }
          <a
            routerLink="/graph"
            [title]="'View graph (' + shortcutGraph + ')'"
            class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600"
          >
            <span class="inline-flex shrink-0" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>
            </span>
            View Graph
            <span class="ml-2 hidden font-normal text-slate-500 sm:inline dark:text-slate-400">{{ shortcutGraph }}</span>
          </a>
        </div>
        @if (canEdit()) {
          <div class="flex shrink-0 w-full sm:w-auto">
            <button
              type="button"
              (click)="openCreate()"
              [title]="'Create task (' + shortcutCreate + ')'"
              class="w-full rounded-lg bg-slate-800 px-4 py-2 text-sm font-medium text-white hover:bg-slate-700 sm:w-auto dark:bg-slate-100 dark:text-black dark:hover:bg-slate-500"
            >
              Create Task
              <span class="ml-2 hidden font-normal opacity-90 sm:inline">{{ shortcutCreate }}</span>
            </button>
          </div>
        }
      </div>
      <!-- Filter row: filters + search left, Sort right; stacks on small screens -->
      <div class="mb-4 flex w-full flex-col gap-3 self-stretch rounded-xl lg:border-none lg:shadow-none border border-slate-200 bg-white p-3 shadow-sm dark:border-slate-700 dark:bg-slate-800 md:flex-row md:items-center md:justify-between">
        <div class="flex min-w-0 flex-wrap items-center gap-3">
          <span class="w-full text-sm font-medium text-slate-600 dark:text-slate-300 sm:w-auto">Filter</span>
          <select
            class="min-w-0 flex-1 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-800 sm:min-w-[140px] dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200"
            [value]="filterCategory()"
            (change)="setFilterCategory($any($event.target).value)"
          >
            <option value="">All categories</option>
            @for (c of categories(); track c.id) {
              <option [value]="c.categoryName">{{ c.categoryName }}</option>
            }
          </select>
          <select
            class="min-w-0 flex-1 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-800 sm:min-w-[140px] dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200"
            [value]="filterCreatedBy()"
            (change)="setFilterCreatedBy($any($event.target).value)"
          >
            <option value="">All creators</option>
            @for (o of taskOwners(); track o.id) {
              <option [value]="o.id">{{ o.label }}</option>
            }
          </select>
          <div class="relative w-full min-w-0 sm:min-w-[200px] sm:flex-1">
            <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            </span>
            <input
              type="search"
              placeholder="Search title or description…"
              class="w-full rounded-lg border border-slate-300 bg-white py-2 pl-9 pr-3 text-sm text-slate-800 placeholder:text-slate-400 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 dark:placeholder:text-slate-400"
              [value]="filterSearch()"
              (input)="setFilterSearch($any($event.target).value)"
            />
          </div>
        </div>
        <div class="flex shrink-0 items-center gap-2 border-t border-slate-100 pt-3 md:border-t-0 md:pt-0 dark:border-slate-600">
          <span class="text-sm font-medium text-slate-600 dark:text-slate-300">Sort</span>
          <select
            class="min-w-0 flex-1 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-800 sm:flex-none dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200"
            [value]="sortBy()"
            (change)="setSortBy($any($event.target).value)"
          >
            <option value="title">Title A–Z</option>
            <option value="createdAt">Newest first</option>
            <option value="updatedAt">Recently updated</option>
          </select>
        </div>
      </div>
      <div class="flex w-full self-stretch px-4 py-4 sm:px-0 lg:px-8">
        <div class="grid w-full grid-cols-1 gap-4 pb-4 md:grid-cols-2 lg:grid-cols-4">
          @for (s of statusesOrdered(); track s.id) {
            <div
              class="flex min-w-0 flex-col rounded-lg border border-slate-200 bg-white shadow-sm transition-shadow dark:border-slate-600 dark:bg-slate-800"
              [attr.data-status]="s.name"
            >
              <div
                class="flex items-center gap-2 rounded-t-lg border-b border-slate-200 px-4 py-3 text-sm font-bold text-slate-800 dark:border-slate-600 dark:text-slate-100"
                [ngClass]="statusHeaderClass(s.name)"
              >
                <span class="h-2.5 w-2.5 shrink-0 rounded-full" [style.background]="statusColor(s.name)" aria-hidden="true"></span>
                <span class="flex-1">{{ statusLabel(s.name) }}</span>
                <span class="rounded-full bg-slate-200/80 px-2 py-0.5 text-xs font-semibold text-slate-600 dark:bg-slate-600 dark:text-slate-300">{{ tasksByStatus()[s.id].length }}</span>
              </div>
              <div
                cdkDropList
                [id]="s.id"
                [cdkDropListData]="tasksByStatus()[s.id]"
                [cdkDropListConnectedTo]="statusListIdsOrdered()"
                (cdkDropListDropped)="drop($event, s.id)"
                class="flex min-h-[120px] flex-1 flex-col p-3"
                [ngClass]="statusPlaceholderClass(s.name)"
              >
                @for (task of tasksByStatus()[s.id]; track task.id) {
                  <div
                    cdkDrag
                    class="mb-2 rounded-md border border-slate-200 bg-white p-3 shadow-sm dark:border-slate-600 dark:bg-slate-800"
                  >
                    <div class="mb-1.5 text-sm font-semibold leading-tight text-slate-800 dark:text-slate-100">{{ task.title }}</div>
                    @if (task.description) {
                      <p class="line-clamp-2 mb-2 text-sm text-slate-500 dark:text-slate-100">
                        {{ task.description }}
                      </p>
                    }
                    <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500 dark:text-slate-100">
                      <span
                        class="max-w-[120px] truncate rounded-full px-2 py-0.5 text-[0.7rem] font-medium text-blue-800 dark:text-black dark:bg-white bg-blue-100"
                        [attr.aria-label]="'Category: ' + (task.category ?? 'none')"
                      >{{ task.category ?? '—' }}</span>
                      <span class="ml-auto">{{ creatorLabel(task) }}</span>
                    </div>
                    @if (canEdit()) {
                      <div class="mt-2 flex justify-end gap-1 border-t border-slate-100 pt-2 dark:border-slate-100">
                        <button
                          type="button"
                          (click)="openEditTask(task, $event)"
                          class="inline-flex items-center gap-1 rounded px-2 py-1 text-xs text-blue-600 hover:bg-slate-100 hover:text-slate-800 dark:text-slate-100 dark:hover:bg-slate-700 dark:hover:text-slate-200"
                          title="Edit"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                          Edit
                        </button>
                        <button
                          type="button"
                          (click)="openDeleteConfirm(task, $event)"
                          class="inline-flex items-center gap-1 rounded px-2 py-1 text-xs text-red-600 hover:bg-red-50 hover:text-red-600 dark:text-slate-100 dark:hover:bg-red-950/30 dark:hover:text-red-400"
                          title="Delete"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                          Delete
                        </button>
                      </div>
                    }
                  </div>
                }
                @if (canEdit()) {
                  <button
                    type="button"
                    (click)="openCreateInColumn(s.id)"
                    class="kanban-placeholder flex min-h-[72px] w-full cursor-pointer items-center gap-2 rounded-lg border-2 border-dashed border-slate-300 px-3 py-4 text-left text-slate-400 dark:text-slate-100 transition-colors hover:border-blue-400 hover:bg-slate-100 hover:text-slate-600 dark:border-slate-600 dark:hover:border-blue-500 dark:hover:bg-slate-700/50 dark:hover:text-slate-300"
                    [ngClass]="statusPlaceholderClass(s.name)"
                  >
                    <span aria-hidden="true">+</span>
                    Add task
                  </button>
                }
              </div>
            </div>
          }
        </div>
      </div>
    }
  </main>

  <p-dialog
    [header]="editingTask() ? 'Edit task' : 'New task'"
    [visible]="showTaskDialog()"
    [modal]="true"
    [style]="{ width: '28rem' }"
    (onHide)="closeTaskDialog()"
    [draggable]="false"
    [resizable]="false"
    styleClass="task-form-dialog"
  >
    <div class="flex flex-col gap-3">
      <div>
        <label class="block text-sm font-medium mb-1">Title</label>
        <input
          type="text"
          pInputText
          [ngModel]="formTitle()"
          (ngModelChange)="formTitle.set($event)"
          placeholder="Task title"
          class="w-full"
        />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Description (optional)</label>
        <textarea
          [ngModel]="formDescription()"
          (ngModelChange)="formDescription.set($event)"
        placeholder="Add notes or comments"
            rows="2"
            class="w-full rounded border border-slate-300 px-3 py-2 dark:border-slate-100 dark:bg-slate-100 dark:text-black"
        ></textarea>
      </div>
      @if (needOwnerOrgSelection()) {
        <div>
          <label class="block text-sm font-medium mb-1">Organization</label>
          <select
            [ngModel]="formOrganizationId()"
            (ngModelChange)="formOrganizationId.set($event)"
            class="w-full rounded border border-slate-300 px-3 py-2 dark:border-slate-100 dark:bg-slate-100 dark:text-black"
            required
          >
            <option value="">Select organization…</option>
            @for (org of organizations(); track org.id) {
              <option [value]="org.id">{{ org.name }}</option>
            }
          </select>
        </div>
      }
      <div>
        <label class="block text-sm font-medium mb-1">Status</label>
        <select
          [ngModel]="formStatusId()"
          (ngModelChange)="formStatusId.set($event)"
          class="w-full rounded border border-slate-300 px-3 py-2 dark:border-slate-100 dark:bg-slate-100 dark:text-black"
        >
          @for (s of statusesOrdered(); track s.id) {
            <option [value]="s.id">{{ statusLabel(s.name) }}</option>
          }
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Category</label>
        <select
          [ngModel]="formCategory()"
          (ngModelChange)="formCategory.set($event); showOtherCategoryInput.set($event === '__other__')"
          class="w-full rounded border border-slate-300 px-3 py-2 dark:border-slate-100 dark:bg-slate-100 dark:text-black"
        >
          @for (c of categories(); track c.id) {
            <option [value]="c.categoryName">{{ c.categoryName }}</option>
          }
          <option [value]="'__other__'">Other…</option>
        </select>
        @if (formCategory() === '__other__' || showOtherCategoryInput()) {
          <div class="mt-2 flex gap-2 items-end">
            <div class="flex-1">
              <label class="block text-xs text-slate-500 dark:text-slate-400">Enter category name</label>
              <input
                type="text"
                [ngModel]="formOtherCategoryName()"
                (ngModelChange)="formOtherCategoryName.set($event)"
                placeholder="e.g. Gardening"
                class="mt-1 w-full rounded border border-slate-300 px-3 py-2 text-sm dark:border-slate-100 dark:bg-slate-100 dark:text-black"
              />
            </div>
            <button
              type="button"
              (click)="addOtherCategory()"
              [disabled]="!formOtherCategoryName().trim()"
              class="rounded bg-slate-200 px-3 py-2 text-sm hover:bg-slate-300 disabled:opacity-50 dark:bg-slate-100 dark:hover:bg-slate-500"
            >
              Add &amp; use
            </button>
          </div>
        }
      </div>
      <div class="mt-4 flex justify-end gap-2 border-t border-slate-200 pt-2 dark:border-slate-600">
        <button
          type="button"
          (click)="closeTaskDialog()"
          class="rounded-lg border border-slate-300 bg-white px-4 py-2 text-slate-700 hover:bg-slate-100 dark:border-slate-600 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-600"
        >
          Cancel
        </button>
        <button
          type="button"
          (click)="saveTask()"
          [disabled]="!formTitle().trim() || (needOwnerOrgSelection() && !formOrganizationId())"
          class="rounded-lg bg-slate-800 px-4 py-2 font-medium text-white hover:bg-slate-700 disabled:opacity-50 dark:bg-slate-900 dark:text-white dark:hover:bg-slate-500"
        >
          {{ editingTask() ? 'Save' : 'Create task' }}
        </button>
      </div>
    </div>
  </p-dialog>

  <p-dialog
    header="Delete task"
    [visible]="!!taskToDelete()"
    [modal]="true"
    [style]="{ width: '22rem' }"
    (onHide)="closeDeleteConfirm()"
    [draggable]="false"
    [resizable]="false"
    [closable]="true"
  >
    <p class="mb-4 text-slate-600 dark:text-slate-800">
      Are you sure you want to delete
      @if (taskToDelete(); as task) {
        <strong class="text-slate-800 dark:text-slate-900">"{{ task.title }}"</strong>
      }
      ?
    </p>
    <div class="flex justify-end gap-2 pt-2">
      <button
        type="button"
        (click)="closeDeleteConfirm()"
        class="rounded-lg border border-slate-300 bg-white px-4 py-2 text-slate-700 hover:bg-slate-100 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600"
      >
        Cancel
      </button>
      <button
        type="button"
        (click)="confirmDeleteTask()"
        class="rounded-lg bg-red-600 px-4 py-2 font-medium text-white hover:bg-red-700 dark:bg-red-600 dark:hover:bg-red-700"
      >
        Delete
      </button>
    </div>
  </p-dialog>
</div>
